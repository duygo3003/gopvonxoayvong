<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Góp Vốn Xoay Vòng 2026 - CĐ CN-NL Khánh Hòa</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f4f6f8; text-align: center; padding: 10px; margin: 0; }
        
        /* HEADER TRƯỜNG */
        .school-header { background: white; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border-bottom: 4px solid #b71c1c; }
        .school-header h1 { color: #b71c1c; margin: 0; font-size: 28px; text-transform: uppercase; letter-spacing: 1px; }
        .school-header h2 { color: #1565c0; margin: 10px 0 0 0; font-size: 22px; font-weight: normal; text-transform: uppercase; }

        .main-container { display: flex; max-width: 1300px; margin: 0 auto; gap: 20px; padding: 0 20px; }
        
        /* Cột trái: Điều khiển */
        .left-panel { flex: 1; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); height: fit-content; text-align: left; }
        /* Cột phải: Khu vực quay */
        .right-panel { flex: 2; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); display: flex; flex-direction: column; align-items: center; min-height: 600px; }

        h3 { color: #37474f; margin-top: 0; border-bottom: 2px solid #eee; padding-bottom: 10px; width: 100%; }
        
        select { width: 100%; padding: 12px; font-size: 16px; margin-bottom: 15px; border-radius: 6px; border: 1px solid #cfd8dc; outline: none; background: #fafafa; }
        select:focus { border-color: #1976d2; box-shadow: 0 0 5px rgba(25, 118, 210, 0.2); }
        
        button { padding: 12px; font-size: 16px; border: none; border-radius: 6px; cursor: pointer; transition: 0.2s; width: 100%; margin-bottom: 10px; font-weight: 600; }
        .btn-select { background-color: #0288d1; color: white; }
        .btn-select:hover { background-color: #0277bd; }
        
        .btn-spin { background: linear-gradient(45deg, #d84315, #ff5722); color: white; font-size: 24px; padding: 25px; width: 70%; box-shadow: 0 6px 15px rgba(216, 67, 21, 0.3); margin-top: 30px; border-radius: 50px; text-transform: uppercase; letter-spacing: 1px; border: 2px solid white; }
        .btn-spin:active { transform: scale(0.98); }
        .btn-spin:disabled { background: #cfd8dc; box-shadow: none; cursor: not-allowed; color: #90a4ae; border: none; }
        
        .btn-export { background-color: #2e7d32; color: white; margin-top: auto; }
        .btn-export:hover { background-color: #1b5e20; }

        /* Hiển thị kết quả quay */
        .result-box { width: 400px; height: 200px; border: 4px dashed #90a4ae; margin: 30px; display: flex; flex-direction: column; align-items: center; justify-content: center; background: #eceff1; border-radius: 15px; transition: all 0.3s; position: relative; }
        .result-text { font-size: 45px; font-weight: bold; color: #c62828; z-index: 2; }
        .result-sub { font-size: 16px; color: #78909c; margin-top: 10px; }
        
        .blinking { animation: blink 0.1s infinite; background: #fff8e1; border-color: #ffb300; border-style: solid; }
        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.8; } 100% { opacity: 1; } }

        /* Thông tin người chơi */
        .player-info { background: #e3f2fd; padding: 20px; border-radius: 10px; width: 90%; margin-bottom: 10px; border-left: 6px solid #1565c0; text-align: left; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .player-name { font-size: 28px; font-weight: bold; color: #0d47a1; margin-bottom: 5px; }
        .player-stats { font-size: 16px; color: #546e7a; }

        /* Bảng lịch sử */
        .history-wrapper { width: 100%; max-height: 400px; overflow-y: auto; margin-top: 10px; border: 1px solid #eee; border-radius: 8px; }
        .history-table { width: 100%; border-collapse: collapse; font-size: 14px; }
        .history-table th { position: sticky; top: 0; background: #455a64; color: white; z-index: 10; padding: 12px; text-align: left; }
        .history-table td { border-bottom: 1px solid #eee; padding: 10px 12px; text-align: left; }
        .history-table tr:nth-child(even) { background-color: #f9f9f9; }
        
        /* Trạng thái slot bên trái */
        .slot-counter { font-size: 14px; margin-top: 10px; max-height: 500px; overflow-y: auto; padding-right: 5px; }
        .slot-item { display: flex; justify-content: space-between; border-bottom: 1px solid #f1f1f1; padding: 10px 0; color: #455a64; }
        .slot-item strong { color: #2e7d32; background: #e8f5e9; padding: 2px 8px; border-radius: 10px; font-size: 12px; }
        .slot-full { color: #bdbdbd; text-decoration: none; opacity: 0.6; }
        .slot-full strong { color: white; background: #bdbdbd; }

        /* Scrollbar đẹp */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #b0bec5; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #78909c; }
    </style>
</head>
<body>

<div class="school-header">
    <h1>TRƯỜNG CĐ CÔNG NGHỆ - NĂNG LƯỢNG KHÁNH HÒA</h1>
    <h2>CHƯƠNG TRÌNH GÓP VỐN XOAY VÒNG NĂM 2026</h2>
</div>

<div class="main-container">
    <div class="left-panel">
        <h3>1. Chọn đoàn viên</h3>
        <select id="memberSelect" size="10" style="height: 150px;"></select>
        <button class="btn-select" onclick="selectMember()">Mời lên sân khấu</button>
        
        <div style="margin-top: 30px;">
            <h3>Thống kê phiếu thăm</h3>
            <div id="slot-status" class="slot-counter"></div>
        </div>
        
        <div style="margin-top: 20px;">
            <button class="btn-export" onclick="exportToExcel()">Xuất báo cáo Excel</button>
            <button onclick="if(confirm('Làm lại từ đầu?')) location.reload()" style="background:#b0bec5; color:white; margin-top:10px;">Reset chương trình</button>
        </div>
    </div>

    <div class="right-panel">
        <div id="player-area" style="width: 100%; display: flex; flex-direction: column; align-items: center;">
            <div class="player-info">
                <div style="font-size: 13px; text-transform: uppercase; color: #78909c; letter-spacing: 1px;">Đang thực hiện bốc thăm:</div>
                <div class="player-name" id="current-player-name">---</div>
                <div class="player-stats" id="current-player-stats">Vui lòng chọn người chơi từ danh sách bên trái</div>
            </div>

            <div id="display-box" class="result-box">
                <div class="result-text" id="result-text">?</div>
                <div class="result-sub">Kết quả ngẫu nhiên</div>
            </div>

            <button id="spinBtn" class="btn-spin" onclick="spin()" disabled>BẮT ĐẦU QUAY</button>
        </div>

        <div style="width: 100%; margin-top: 30px; flex-grow: 1;">
            <h3>Kết quả vừa quay</h3>
            <div class="history-wrapper">
                <table class="history-table" id="resultTable">
                    <thead>
                        <tr>
                            <th width="10%">STT</th>
                            <th width="35%">Họ tên</th>
                            <th width="25%">Đơn vị</th>
                            <th width="30%">Kết quả trúng</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    // --- CẤU HÌNH ĐẶC BIỆT ---
    // CẬP NHẬT: Thêm Nguyễn Duy Gơ vào tháng 02
    const FIXED_ALLOCATIONS = {
        "Nguyễn Thị Thanh Dung": ["Tháng 02/2026", "Tháng 02/2026"],
        "Nguyễn Duy Gơ": ["Tháng 02/2026"]
    };

    // 1. Dữ liệu Danh sách đoàn viên
    const membersData = [
        {name: 'Vũ Thị Lụa', dept: 'Khối văn phòng', shares: 2},
        {name: 'Trần Thị Thương', dept: 'Khối văn phòng', shares: 1},
        {name: 'Nguyễn Thị Lê', dept: 'Khối văn phòng', shares: 1},
        {name: 'Nguyễn Lê Thanh Thảo', dept: 'Khối văn phòng', shares: 2},
        {name: 'Tài Thị Đoan Trang', dept: 'Khối văn phòng', shares: 2},
        {name: 'Huỳnh Thị Mỹ Liên', dept: 'Khối văn phòng', shares: 3},
        {name: 'Nguyễn Võ Quỳnh Trân', dept: 'Khối văn phòng', shares: 1},
        {name: 'Lê Thị Hồng', dept: 'Khối văn phòng', shares: 3},
        {name: 'Nguyễn Đình Phong', dept: 'Khối văn phòng', shares: 3},
        {name: 'Huỳnh Ngọc Tường Vy', dept: 'Khối văn phòng', shares: 1},
        {name: 'Nguyễn Nữ Ngọc Tuyền', dept: 'Khối văn phòng', shares: 1},
        {name: 'Nguyễn Thị Tươi', dept: 'Khối văn phòng', shares: 1},
        {name: 'Thiết Thị Thanh Minh', dept: 'Khối văn phòng', shares: 2},
        {name: 'Nguyễn Thị Thanh Dung', dept: 'Khối văn phòng', shares: 2},
        {name: 'Phạm Vũ Đăng Tùng', dept: 'Khối văn phòng', shares: 1},
        {name: 'Lê Nguyên Khải', dept: 'Khối văn phòng', shares: 1},
        {name: 'Nguyễn Đặng Hồng Duyên', dept: 'Khối văn phòng', shares: 1},
        {name: 'Phùng Thị Lành', dept: 'Khối văn phòng', shares: 1},
        {name: 'Nguyễn Quốc Hoàn', dept: 'Khối văn phòng', shares: 1},
        {name: 'Trần Trung Dũng', dept: 'Điện - Điện tử', shares: 1},
        {name: 'Nguyễn Xuân', dept: 'Điện - Điện tử', shares: 2},
        {name: 'Trần Thị Hồng', 'dept': 'Điện - Điện tử', shares: 2},
        {name: 'Thiên Khương Tùng', 'dept': 'Điện - Điện tử', shares: 2},
        {name: 'Đạt Hưng', 'dept': 'Điện - Điện tử', shares: 1},
        {name: 'Lê Quốc Duy', 'dept': 'Điện - Điện tử', shares: 2},
        {name: 'Kiều Văn Hoài', 'dept': 'Điện - Điện tử', shares: 2},
        {name: 'Trần Quang Trung', 'dept': 'Điện - Điện tử', shares: 1},
        {name: 'Nguyễn Huỳnh Minh', 'dept': 'Công nghệ ô tô', shares: 2},
        {name: 'Thành Thị Thái Thi', 'dept': 'Công nghệ ô tô', shares: 3},
        {name: 'Vũ Minh Thuấn', 'dept': 'Công nghệ ô tô', shares: 2},
        {name: 'Đàng Ngọc Võng', 'dept': 'Cơ khí - Xây dựng', shares: 3},
        {name: 'Huỳnh Trung Dũng', 'dept': 'Cơ khí - Xây dựng', shares: 3},
        {name: 'Nguyễn Đỗ Quốc Trung', 'dept': 'Cơ khí - Xây dựng', shares: 2},
        {name: 'Phạm Thị Như Kiều Anh', 'dept': 'Cơ khí - Xây dựng', shares: 2},
        {name: 'Nguyễn Duy Gơ', 'dept': 'Cơ khí - Xây dựng', shares: 1},
        {name: 'Ngô Thị Kim Hậu', 'dept': 'Cơ khí - Xây dựng', shares: 1},
        {name: 'Phan Văn Quảng', 'dept': 'Cơ khí - Xây dựng', shares: 2},
        {name: 'Trần Duy Tín', 'dept': 'Kinh tế - tổng hợp', shares: 2},
        {name: 'Trần Thị Bích Lành', 'dept': 'Kinh tế - tổng hợp', shares: 3},
        {name: 'Phan Thị Yến Nhi', 'dept': 'Kinh tế - tổng hợp', shares: 4},
        {name: 'Hồ Ngọc Thùy Dương', 'dept': 'Kinh tế - tổng hợp', shares: 2},
        {name: 'Phạm Thị Diệu Huyền', 'dept': 'Kinh tế - tổng hợp', shares: 1},
        {name: 'Nguyễn Tiến Vũ', 'dept': 'Trung tâm ĐTLX', shares: 1},
        {name: 'Nguyễn Thị Thanh Hòa', 'dept': 'Trung tâm ĐTLX', shares: 1},
        {name: 'Nguyễn Duy Khang', 'dept': 'Trung tâm ĐTLX', shares: 1},
        {name: 'Lữ Thị Bích Thúy', 'dept': 'Trung tâm ĐTLX', shares: 1},
        {name: 'Võ Ngọc Chương', 'dept': 'Trung tâm ĐTLX', shares: 2},
        {name: 'Nguyễn Thái Trí', 'dept': 'Trung tâm ĐTLX', shares: 3},
        {name: 'Hoàng Anh Thư', 'dept': 'Trung tâm ĐTLX', shares: 2},
        {name: 'Phạm Như Hùng', 'dept': 'Trung tâm ĐTLX', shares: 3},
        {name: 'Lê Thiết Hùng', 'dept': 'Trung tâm ĐTLX', shares: 4},
        {name: 'Nguyễn Duy Cương', 'dept': 'Trung tâm ĐTLX', shares: 2},
        {name: 'Nguyễn Phan Anh Quốc', 'dept': 'TT GDNN & QHDN', shares: 2},
        {name: 'Hồ Hữu Pha', 'dept': 'TT GDNN & QHDN', shares: 2},
        {name: 'Nguyễn Thị Phương Thảo', 'dept': 'TT GDNN & QHDN', shares: 1},
        {name: 'Nguyễn Thị Thùy Lan', 'dept': 'TT GDNN & QHDN', shares: 1},
        {name: 'Nguyễn Thị Bích Dung', 'dept': 'TT GDNN & QHDN', shares: 1},
        {name: 'Quảng Đùi', 'dept': 'TT GDNN & QHDN', shares: 1},
        {name: 'Trương Phan Nhật Quỳnh', 'dept': 'TT GDNN & QHDN', shares: 1}
    ];

    // 2. Khởi tạo quỹ thời gian
    let availableSlots = [];        // Quỹ vé chung
    let reservedSlots = {};         // Quỹ vé riêng
    
    const months = 15;
    const slotsPerMonth = 7;
    const startYear = 2026;
    
    function initSlots() {
        // Bước 1: Tạo tất cả 105 vé
        let allTickets = [];
        for(let i=0; i<months; i++) {
            let month = (i + 1) % 12;
            if (month === 0) month = 12;
            let year = startYear + Math.floor((i) / 12);
            let label = `Tháng ${month.toString().padStart(2, '0')}/${year}`;
            
            for(let j=0; j<slotsPerMonth; j++) {
                allTickets.push(label);
            }
        }

        // Bước 2: Tách vé cho VIP
        for (let vipName in FIXED_ALLOCATIONS) {
            reservedSlots[vipName] = [];
            let requestedMonths = FIXED_ALLOCATIONS[vipName];
            
            requestedMonths.forEach(reqMonth => {
                // Tìm vé trong kho
                let foundIndex = allTickets.indexOf(reqMonth);
                if (foundIndex !== -1) {
                    // Lấy vé ra khỏi kho chung, bỏ vào kho riêng
                    let ticket = allTickets.splice(foundIndex, 1)[0];
                    reservedSlots[vipName].push(ticket);
                } else {
                    console.error(`CẢNH BÁO: Không đủ vé ${reqMonth} để giữ chỗ cho ${vipName}`);
                }
            });
        }

        // Bước 3: Số vé còn lại đưa vào availableSlots
        availableSlots = allTickets;
    }
    
    initSlots();

    // Biến trạng thái
    let currentPlayer = null;
    let currentSpinsLeft = 0;
    let globalResults = []; 

    // 3. Khởi tạo giao diện
    const selectBox = document.getElementById('memberSelect');
    membersData.forEach((m, idx) => {
        let option = document.createElement("option");
        option.value = idx;
        option.text = `${idx+1}. ${m.name} (${m.shares} suất)`;
        selectBox.add(option);
    });

    updateSlotStatus();

    // 4. Hàm chức năng
    function selectMember() {
        const idx = selectBox.value;
        if (idx === "") return;
        
        const member = membersData[idx];
        
        // Kiểm tra xem người này đã quay hết chưa
        const playedCount = globalResults.filter(r => r.name === member.name).length;
        const remain = member.shares - playedCount;

        currentPlayer = member;
        currentSpinsLeft = remain;

        document.getElementById('current-player-name').innerText = member.name;
        document.getElementById('result-text').innerText = "?";
        document.getElementById('result-text').style.color = "#c62828";
        
        updateUI();
    }

    function updateUI() {
        const statusDiv = document.getElementById('current-player-stats');
        const spinBtn = document.getElementById('spinBtn');
        
        if (currentSpinsLeft > 0) {
            statusDiv.innerHTML = `Còn lại <strong style="color:red; font-size:20px">${currentSpinsLeft}</strong> lượt bấm (Tổng đăng ký: ${currentPlayer.shares})`;
            spinBtn.innerText = `BẤM ĐỂ QUAY`;
            spinBtn.disabled = false;
            spinBtn.style.background = "linear-gradient(45deg, #d84315, #ff5722)";
        } else {
            statusDiv.innerText = "Đã hoàn thành bốc thăm!";
            statusDiv.style.color = "green";
            spinBtn.innerText = "ĐÃ XONG";
            spinBtn.disabled = true;
            spinBtn.style.background = "#cfd8dc";
        }
        updateSlotStatus();
    }

    function spin() {
        if (currentSpinsLeft <= 0) return;
        
        // Kiểm tra xem người chơi có vé reserved không?
        let isVip = reservedSlots[currentPlayer.name] && reservedSlots[currentPlayer.name].length > 0;
        
        if (!isVip && availableSlots.length === 0) return alert("Đã hết phiếu thăm trong thùng phiếu!");

        const btn = document.getElementById('spinBtn');
        const displayBox = document.getElementById('display-box');
        const displayText = document.getElementById('result-text');
        
        btn.disabled = true;
        displayBox.classList.add('blinking');
        
        // Hiệu ứng chạy số giả lập
        let previewPool = availableSlots.length > 0 ? availableSlots : ["Hết vé"];
        if (isVip) previewPool = [...availableSlots, ...reservedSlots[currentPlayer.name]];

        let counter = 0;
        let shuffleInterval = setInterval(() => {
            const randomPreview = previewPool[Math.floor(Math.random() * previewPool.length)];
            displayText.innerText = randomPreview;
            counter++;
            if (counter > 15) clearInterval(shuffleInterval);
        }, 80);

        setTimeout(() => {
            clearInterval(shuffleInterval);
            displayBox.classList.remove('blinking');
            
            // --- CHỐT KẾT QUẢ THẬT ---
            let winMonth = "";

            if (isVip) {
                // Lấy vé từ kho riêng
                winMonth = reservedSlots[currentPlayer.name].shift(); 
            } else {
                // Lấy vé từ kho chung ngẫu nhiên
                const winIndex = Math.floor(Math.random() * availableSlots.length);
                winMonth = availableSlots[winIndex];
                availableSlots.splice(winIndex, 1);
            }
            
            displayText.innerText = winMonth;
            displayText.style.color = "#2e7d32";
            
            // Lưu kết quả
            recordResult(winMonth);
            
            currentSpinsLeft--;
            updateUI();
            
        }, 1500);
    }

    function recordResult(month) {
        const result = {
            stt: globalResults.length + 1,
            name: currentPlayer.name,
            dept: currentPlayer.dept,
            month: month,
            timestamp: new Date()
        };
        globalResults.push(result);

        // Thêm vào bảng hiển thị
        const tbody = document.querySelector('#resultTable tbody');
        const row = `<tr style="background-color: #e8f5e9; animation: fadeIn 0.5s;">
            <td>${result.stt}</td>
            <td style="font-weight:bold">${result.name}</td>
            <td>${result.dept}</td>
            <td style="color:#d32f2f; font-weight:bold">${result.month}</td>
        </tr>`;
        tbody.insertAdjacentHTML('afterbegin', row);
    }

    function updateSlotStatus() {
        const container = document.getElementById('slot-status');
        let counts = {};
        
        // Đếm vé trong kho chung
        availableSlots.forEach(s => {
            counts[s] = (counts[s] || 0) + 1;
        });

        // Đếm vé trong kho riêng
        for (let user in reservedSlots) {
            reservedSlots[user].forEach(s => {
                counts[s] = (counts[s] || 0) + 1;
            });
        }

        let html = '';
        for(let i=0; i<months; i++) {
            let month = (i + 1) % 12;
            if (month === 0) month = 12;
            let year = startYear + Math.floor((i) / 12);
            let label = `Tháng ${month.toString().padStart(2, '0')}/${year}`;
            
            let count = counts[label] || 0;
            let styleClass = count === 0 ? 'slot-full' : '';
            
            html += `<div class="slot-item ${styleClass}">
                <span>${label}</span>
                <strong>Còn ${count} suất</strong>
            </div>`;
        }
        container.innerHTML = html;
    }

    function exportToExcel() {
        let table = document.getElementById("resultTable");
        let html = `
            <html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40">
            <head><meta charset="UTF-8"></head>
            <body>
                <h2>TRƯỜNG CĐ CÔNG NGHỆ - NĂNG LƯỢNG KHÁNH HÒA</h2>
                <h3>KẾT QUẢ BỐC THĂM GÓP VỐN 2026</h3>
                ${table.outerHTML}
            </body>
            </html>`;
        
        let blob = new Blob([html], { type: 'application/vnd.ms-excel' });
        let downloadLink = document.createElement("a");
        downloadLink.href = URL.createObjectURL(blob);
        downloadLink.download = 'Ket_Qua_Gop_Von_CD_CNNL_2026.xls';
        document.body.appendChild(downloadLink);
        downloadLink.click();
        document.body.removeChild(downloadLink);
    }
</script>

<style>
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(-10px); }
  to { opacity: 1; transform: translateY(0); }
}
</style>

</body>
</html>